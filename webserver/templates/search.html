<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>ImageDB – Compound Search</title>
  <link rel="shortcut icon" href="/static/pharmbio_logo_square_64x64.png" type="image/x-icon">

  <!-- Bootstrap & your CSS -->
  <link href="/static/theme/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/theme/css/simple-sidebar.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/main.css?version=1.x">

  <style>
    /* Existing card/grid styling (used inside the tree leaves) */
    .thumb-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 120px));
      gap: .6rem;
      margin: .5rem 0 .5rem 1.25rem;
    }
    .thumb-card {
      position: relative;
      overflow: hidden;
      border-radius: 4px;
      background: #f8f8f8;
      cursor: pointer;
    }
    .thumb-card img {
      width: 100%;
      height: auto;
      transition: filter .2s;
    }
    .thumb-meta {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: rgba(0,0,0,.45);
      color: #fff;
      font-size: .75rem;
      padding: .15rem;
      text-align: center;
    }
    .thumb-card.thumb-selected {
      outline: 3px solid #17a2b8;
      box-shadow: 0 0 0 2px rgba(23,162,184,.3);
    }
    .thumb-card .thumb-select-check {
      position: absolute;
      top: 4px;
      left: 4px;
      z-index: 2;
    }
    .thumb-card .thumb-info-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      z-index: 2;
      padding: 0 .4rem;
      font-size: .7rem;
      line-height: 1.4;
    }
    #image-info-panel {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 260px;
      max-height: 60vh;
      overflow: auto;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: .25rem;
      box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,.15);
      z-index: 1050;
      display: none;
    }
    #image-info-panel .info-header {
      cursor: move;
      padding: .25rem .5rem;
      background: #f7f7f7;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #image-info-panel .info-body {
      padding: .5rem .75rem .75rem;
    }
    #selected-panel {
      position: fixed;
      top: 80px;
      right: 300px;
      width: 260px;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: .25rem;
      box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,.15);
      z-index: 1050;
      display: none;
      resize: both;
      overflow: hidden;
      min-width: 220px;
      min-height: 120px;
      max-width: 90vw;
      max-height: 80vh;
    }
    #selected-panel .selected-header {
      cursor: move;
      padding: .25rem .5rem;
      background: #f7f7f7;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #selected-panel .selected-body {
      padding: .5rem .75rem .75rem;
      max-height: calc(80vh - 40px);
      overflow-y: auto;
    }

    /* Tree view */
    .tree details { margin: .25rem 0 .25rem .75rem; }
    .tree summary { cursor: pointer; user-select: none; outline: none; }
    .tree .badge {
      font-size: .75rem;
      background: #eef;
      border: 1px solid #cfe;
      padding: .05rem .35rem;
      border-radius: .4rem;
      margin-left: .4rem;
    }

    /* Date badge: soft yellow */
    .badge-date{
      background: #fff3cd;          /* light yellow */
      border: 1px solid #ffe8a1;    /* pale border */
      color: #7a5d00;               /* muted amber text */
      border-radius: .4rem;
      padding: .05rem .35rem;
      margin-left: .4rem;
      font-size: .75rem;
    }

    /* Controls layout */
    .control-label { margin-right: .5rem; }
    .control-input { width: 90px; }
    .control-input.w110 { width: 110px; }
    .control-input.w120 { width: 120px; }

    /* Pill counters */
    .pill {
      display: inline-block;
      padding: 0 .5rem;
      background: #f0f0f0;
      border-radius: 1rem;
      font-size: .75rem;
      margin-left: .35rem;
      color: #333;
    }
    </style>
</head>

<body>
  <!-- Top bar with search -->
  <nav class="navbar navbar-light bg-light border-bottom">
    <form id="search-form" class="form-inline mx-3" onsubmit="return false;">
      <select id="field" class="form-control mr-2">
        <option value="">Compound: Any Field</option>
        <option value="inchi">Compound: inchi</option>
        <option value="compound_name">Compound: compound_name</option>
        <option value="batchid">Compound: batchid</option>
        <option value="cbkid">Compound: cbkid</option>
        <option value="libid">Compound: libid</option>
        <option value="libtxt">Compound: libtxt</option>
        <option value="smiles">Compound: smiles</option>
        <option value="inkey">Compound: inkey</option>
      </select>
      <input type="text" id="q" class="form-control mr-2" placeholder="Search term...." required>
      <button class="btn btn-info" type="submit">Search</button>
    </form>
  </nav>

  <div class="container-fluid mt-3">
    <!-- Controls: brightness, zoom, limits -->
    <div class="form-inline mb-3">
      <label class="control-label mr-3">
        Brightness
        <input type="range" id="brightness-range" min="0" max="3000" value="300" class="form-control-range ml-2">
      </label>
      <label class="control-label mr-4">
        Zoom
        <input type="range" id="zoom-range" min="50" max="200" value="150" class="form-control-range ml-2">
      </label>

      <!-- Equalize -->
      <div class="form-group form-check ml-3 mb-0">
        <div class="form-check">
          <input
            type="checkbox"
            class="form-check-input"
            id="equalize-cb"
            style="margin-top: .3rem;"
            title="Apply auto white balance: adjust relative R/G/B gains so colors look neutral and no channel dominates."
          >
          <label
            class="form-check-label"
            for="equalize-cb"
            style="margin-top: .1rem;"
            title="Apply auto white balance: adjust relative R/G/B gains so colors look neutral and no channel dominates."
            data-toggle="tooltip" data-bs-toggle="tooltip"
          >Equalize</label>
        </div>
      </div>

      <!-- Normalize -->
      <div class="form-group form-check ml-3 mb-0">
        <div class="form-check">
          <input
            type="checkbox"
            class="form-check-input"
            id="normalize-cb"
            style="margin-top: .3rem;"
            title="Rescale each channel independently to the full 0–255 range (contrast normalization). Enhances dim details, but alters absolute brightness scaling."
          >
          <label
            class="form-check-label"
            for="normalize-cb"
            style="margin-top: .1rem;"
            title="Rescale each channel independently to the full 0–255 range (contrast normalization). Enhances dim details, but alters absolute brightness scaling."
            data-toggle="tooltip" data-bs-toggle="tooltip"
          >Normalize</label>
        </div>
      </div>

      <label class="control-label mr-2 ml-3">Limit plates
        <input type="number" id="limit-plates" class="form-control ml-2 control-input" min="1" placeholder="∞">
      </label>
      <label class="control-label mr-2">Limit acq/plate
        <input type="number" id="limit-acqs" class="form-control ml-2 control-input w110" min="1" placeholder="∞">
      </label>
      <label class="control-label mr-2">Limit wells/plate
        <input type="number" id="limit-wells" class="form-control ml-2 control-input w120" min="1" placeholder="∞">
      </label>
      <label class="control-label mr-2">Limit sites/well
        <input type="number" id="limit-sites" class="form-control ml-2 control-input w110" min="1" placeholder="∞">
      </label>
    </div>


    <!-- Results summary row -->
    <div class="mb-2">
      <span>Projects <span id="count-projects" class="pill">0</span></span>
      <span class="ml-2">Plates <span id="count-plates" class="pill">0</span></span>
      <span class="ml-2">Acquisitions <span id="count-acqs" class="pill">0</span></span>
      <span class="ml-2">Wells <span id="count-wells" class="pill">0</span></span>
      <span class="ml-2">Selected <span id="selected-count" class="pill">0</span></span>
      <button id="selected-modal-btn" class="btn btn-sm btn-outline-info ml-2" type="button" disabled>
        Show selected
      </button>
      <button id="save-selected-btn" class="btn btn-sm btn-outline-success ml-2" type="button" disabled>
        Save selected…
      </button>
    </div>

    <!-- Expand all -->
    <div class="mb-2">
      <button id="expand-all-btn" class="btn btn-sm btn-secondary mr-3">Expand all</button>
      <button id="sort-mode-btn" class="btn btn-sm btn-outline-secondary">Sort by Name/Date</button>
    </div>

    <!-- Tree root -->
    <div id="tree-root" class="tree"></div>
  </div>

  <!-- Selected images panel -->
  <div id="selected-panel">
    <div class="selected-header" id="selected-header">
      <span class="small font-weight-bold">Selected images</span>
      <button type="button" id="selected-close" class="close" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="selected-body">
      <p class="mb-2">
        You have <span id="selected-count-modal">0</span> selected image(s).
      </p>
      <ul id="selected-list" class="list-group small mb-0"></ul>
    </div>
  </div>

  <!-- Save selected images options -->
  <div id="save-selected-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Save selected images</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="opt-merged-rgb" checked>
            <label class="form-check-label" for="opt-merged-rgb">
              Merged RGB image
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="opt-original-channels">
            <label class="form-check-label" for="opt-original-channels">
              Original channel images
            </label>
          </div>
          <div id="save-selected-status" class="mt-2 small text-muted" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" id="save-selected-cancel">Cancel</button>
          <button type="button" class="btn btn-primary" id="save-selected-confirm">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Image info Modal -->
  <div id="image-info-panel">
    <div class="info-header" id="image-info-header">
      <span class="small font-weight-bold">Image details</span>
      <button type="button" id="image-info-close" class="close" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="info-body">
      <dl class="row mb-0 small">
        <dt class="col-sm-4">Project</dt>
        <dd class="col-sm-8" id="info-project"></dd>
        <dt class="col-sm-4">Plate</dt>
        <dd class="col-sm-8" id="info-plate"></dd>
        <dt class="col-sm-4">Acq ID</dt>
        <dd class="col-sm-8" id="info-acq-id"></dd>
        <dt class="col-sm-4">Acq date</dt>
        <dd class="col-sm-8" id="info-acq-date"></dd>
        <dt class="col-sm-4">Well</dt>
        <dd class="col-sm-8" id="info-well"></dd>
        <dt class="col-sm-4">Site</dt>
        <dd class="col-sm-8" id="info-site"></dd>
        <dt class="col-sm-4">Z positions</dt>
        <dd class="col-sm-8" id="info-zcount"></dd>
        <dt class="col-sm-4">Channels (first Z)</dt>
        <dd class="col-sm-8" id="info-channels"></dd>
      </dl>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="error-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Error</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span>×</span></button>
      </div>
      <div class="modal-body"><pre id="error-message" style="white-space:pre-wrap"></pre></div>
    </div></div>
  </div>

  <!-- JS deps -->
  <script src="/static/theme/vendor/jquery/jquery.min.js"></script>
  <script src="/static/theme/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- Keep your site-wide JS if needed -->
  <script src="/static/main.js?version=1.23"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      function sleep(ms){return new Promise(r=>setTimeout(r, ms));}

      // --- Concurrency limiter for fetches (limits parallel plate/well loads) ---
      const SEM_MAX_CONCURRENT = 4; // tune if you want more/less parallelism
      let semInFlight = 0;
      async function withSemaphore(fn) {
        while (semInFlight >= SEM_MAX_CONCURRENT) { await sleep(30); }
        semInFlight++;
        try { return await fn(); }
        finally { semInFlight--; }
      }

      // Smoother "Expand all": expand level-by-level and then nudge images to eager
      async function expandAllTree(){
        const root = document.getElementById('tree-root');
        if(!root) return;

        // Expand progressively so lazy loaders can attach and populate
        const pass = async (selector, delay=40) => {
          const nodes = Array.from(root.querySelectorAll(selector));
          for (const d of nodes) { d.open = true; await sleep(delay); }
        };
        await pass(':scope > details', 40);               // projects
        await pass('details > details', 30);              // plates
        await pass('details > details > details', 25);    // acquisitions
        await pass('details details details details', 10);// wells

        // Make images download promptly once nodes exist
        root.querySelectorAll('img[loading="lazy"]').forEach(img => {
          try {
            img.loading = 'eager';
            img.decoding = 'async';
            img.setAttribute('fetchpriority','high');
          } catch(e){}
        });
      }
      const expandBtn = document.getElementById('expand-all-btn');
      if (expandBtn) expandBtn.addEventListener('click', () => { expandAllTree(); });

      // Sort mode (projects): 'date' (latest first, default) or 'name' (A–Ö)
      let SORT_MODE = 'date';
      const sortBtn = document.getElementById('sort-mode-btn');
      if (sortBtn) {
        sortBtn.addEventListener('click', () => {
          SORT_MODE = (SORT_MODE === 'date') ? 'name' : 'date';
          const term = document.getElementById('q').value.trim();
          if (term) {
            renderSearchResults(term); // re-render with new sort mode
          }
        });
      }

      const treeRoot     = document.getElementById('tree-root');
      const errorModal   = $('#error-modal');
      const errorMsgPre  = document.getElementById('error-message');
      const brightnessEl = document.getElementById('brightness-range');
      const selectedCountEl = document.getElementById('selected-count');
      const selectedCountModalEl = document.getElementById('selected-count-modal');
      const selectedListEl = document.getElementById('selected-list');
      const selectedModalBtn = document.getElementById('selected-modal-btn');
      const selectedPanel = document.getElementById('selected-panel');
      const selectedHeader = document.getElementById('selected-header');
      const selectedCloseBtn = document.getElementById('selected-close');
      const saveSelectedBtn = document.getElementById('save-selected-btn');
      const saveSelectedModal = $('#save-selected-modal');
      const saveSelectedConfirmBtn = document.getElementById('save-selected-confirm');
      const saveSelectedCancelBtn = document.getElementById('save-selected-cancel');
      const optMerged = document.getElementById('opt-merged-rgb');
      const optOriginal = document.getElementById('opt-original-channels');
      const infoPanel = document.getElementById('image-info-panel');
      const infoHeader = document.getElementById('image-info-header');
      const infoCloseBtn = document.getElementById('image-info-close');
      const infoProjectEl  = document.getElementById('info-project');
      const infoPlateEl    = document.getElementById('info-plate');
      const infoAcqIdEl    = document.getElementById('info-acq-id');
      const infoAcqDateEl  = document.getElementById('info-acq-date');
      const infoWellEl     = document.getElementById('info-well');
      const infoSiteEl     = document.getElementById('info-site');
      const infoZCountEl   = document.getElementById('info-zcount');
      const infoChannelsEl = document.getElementById('info-channels');
      const normalizeCb    = document.getElementById('normalize-cb');
      const equalizeCb     = document.getElementById('equalize-cb');
      const saveSelectedStatusEl = document.getElementById('save-selected-status');
      let saveAbortController = null;

      const selectedImages = new Map();
      const makeSelectionKey = (barcode, acqId, wellId, siteKey) =>
        `${barcode}|${acqId}|${wellId}|${siteKey}`;

      function buildThumbFilterQuery() {
        const parts = [];
        if (normalizeCb) {
          parts.push(`normalize=${normalizeCb.checked ? '1' : '0'}`);
        }
        if (equalizeCb) {
          parts.push(`equalize=${equalizeCb.checked ? '1' : '0'}`);
        }
        return parts.join('&');
      }

      function addThumbFilterParams(url) {
        const q = buildThumbFilterQuery();
        if (!q) return url;
        const sep = url.includes('?') ? '&' : '?';
        return url + sep + q;
      }

      function updateSelectedCount() {
        const n = selectedImages.size;
        if (selectedCountEl) selectedCountEl.textContent = String(n);
        if (selectedCountModalEl) selectedCountModalEl.textContent = String(n);
        const disabled = n === 0;
        if (selectedModalBtn) selectedModalBtn.disabled = disabled;
        if (saveSelectedBtn) saveSelectedBtn.disabled = disabled;
      }

      function refreshSelectedList() {
        if (!selectedListEl) return;
        selectedListEl.innerHTML = '';
        if (selectedImages.size === 0) {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = 'No selected images.';
          selectedListEl.appendChild(li);
          return;
        }
        for (const { barcode, acqId, wellId, siteKey } of selectedImages.values()) {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = `Plate ${barcode} – Acq ${acqId} – Well ${wellId} – Site ${siteKey}`;
          selectedListEl.appendChild(li);
        }
      }

      function toggleThumbSelection(card, forceSelected = null) {
        const { barcode, acqId, wellId, siteKey } = card.dataset;
        const key = makeSelectionKey(barcode, acqId, wellId, siteKey);
        const currentlySelected = selectedImages.has(key);
        const willSelect = (forceSelected === null) ? !currentlySelected : !!forceSelected;

        if (willSelect) {
          const { ch1, ch2, ch3, batchId, compoundName, projectName } = card.dataset;
          selectedImages.set(key, {
            barcode,
            acqId,
            wellId,
            siteKey,
            ch1,
            ch2,
            ch3,
            batchId,
            compoundName,
            projectName,
          });
        } else {
          selectedImages.delete(key);
        }
        card.classList.toggle('thumb-selected', willSelect);
        updateSelectedCount();
        if (selectedPanel && selectedPanel.style.display !== 'none') {
          refreshSelectedList();
        }
      }

      function openViewerFromThumb(card, siteInfo) {
        const { barcode, acqId, wellId, siteKey } = card.dataset;
        if (!barcode || !acqId || !wellId || !siteKey) return;

        const zPositions = (siteInfo && siteInfo.z_positions) || {};
        const zKeys = Object.keys(zPositions);
        const zpos = zKeys.length ? zKeys[0] : '0';
        const channel = '-';

        const viewerUrl =
          `/image-viewer/${encodeURIComponent(barcode)}` +
          `/tp/${encodeURIComponent(acqId)}` +
          `/well/${encodeURIComponent(wellId)}` +
          `/site/${encodeURIComponent(siteKey)}` +
          `/zpos/${encodeURIComponent(zpos)}` +
          `/ch/${encodeURIComponent(channel)}` +
          `/url/x`;

        window.open(viewerUrl, '_blank');
      }

      function openInfoPanel(card, siteInfo) {
        if (!infoPanel) return;
        const { barcode, acqId, wellId, siteKey, projectName, acqDateIso } = card.dataset;
        if (infoProjectEl)  infoProjectEl.textContent  = projectName || '';
        if (infoPlateEl)    infoPlateEl.textContent    = barcode || '';
        if (infoAcqIdEl)    infoAcqIdEl.textContent    = acqId || '';
        if (infoAcqDateEl)  infoAcqDateEl.textContent  = acqDateIso ? fmtDate(acqDateIso) : '';
        if (infoWellEl)     infoWellEl.textContent     = wellId || '';
        if (infoSiteEl)     infoSiteEl.textContent     = siteKey || '';

        const zPositions = (siteInfo && siteInfo.z_positions) || {};
        const zKeys = Object.keys(zPositions);
        if (infoZCountEl) infoZCountEl.textContent = String(zKeys.length);

        let channelsSummary = '';
        if (zKeys.length) {
          const firstZ = zPositions[zKeys[0]] || {};
          const chans = firstZ.channels || {};
          const dyes = [];
          for (const ch of Object.values(chans)) {
            if (ch && ch.dye) dyes.push(ch.dye);
          }
          channelsSummary = dyes.length ? dyes.join(', ') : '';
        }
        if (infoChannelsEl) infoChannelsEl.textContent = channelsSummary;

        infoPanel.style.display = 'block';
      }

      // Simple drag behavior for the info panel
      if (infoPanel && infoHeader) {
        let dragActive = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        const onMove = ev => {
          if (!dragActive) return;
          const x = ev.clientX - dragOffsetX;
          const y = ev.clientY - dragOffsetY;
          infoPanel.style.left = `${x}px`;
          infoPanel.style.top = `${y}px`;
          infoPanel.style.right = 'auto';
        };
        const onUp = () => {
          dragActive = false;
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        };

        infoHeader.addEventListener('mousedown', ev => {
          ev.preventDefault();
          const rect = infoPanel.getBoundingClientRect();
          dragActive = true;
          dragOffsetX = ev.clientX - rect.left;
          dragOffsetY = ev.clientY - rect.top;
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
        });
      }

      if (infoCloseBtn && infoPanel) {
        infoCloseBtn.addEventListener('click', () => {
          infoPanel.style.display = 'none';
        });
      }

      if (selectedModalBtn && selectedPanel) {
        selectedModalBtn.addEventListener('click', () => {
          refreshSelectedList();
          selectedPanel.style.display = 'block';
        });
      }

      // Simple drag behavior for the selected panel
      if (selectedPanel && selectedHeader) {
        let dragActiveSel = false;
        let dragSelOffsetX = 0;
        let dragSelOffsetY = 0;

        const onMoveSel = ev => {
          if (!dragActiveSel) return;
          const x = ev.clientX - dragSelOffsetX;
          const y = ev.clientY - dragSelOffsetY;
          selectedPanel.style.left = `${x}px`;
          selectedPanel.style.top = `${y}px`;
          selectedPanel.style.right = 'auto';
        };
        const onUpSel = () => {
          dragActiveSel = false;
          document.removeEventListener('mousemove', onMoveSel);
          document.removeEventListener('mouseup', onUpSel);
        };

        selectedHeader.addEventListener('mousedown', ev => {
          ev.preventDefault();
          const rect = selectedPanel.getBoundingClientRect();
          dragActiveSel = true;
          dragSelOffsetX = ev.clientX - rect.left;
          dragSelOffsetY = ev.clientY - rect.top;
          document.addEventListener('mousemove', onMoveSel);
          document.addEventListener('mouseup', onUpSel);
        });
      }

      if (selectedCloseBtn && selectedPanel) {
        selectedCloseBtn.addEventListener('click', () => {
          selectedPanel.style.display = 'none';
        });
      }

      if (saveSelectedBtn && saveSelectedModal) {
        saveSelectedBtn.addEventListener('click', () => {
          if (!selectedImages.size) return;
          saveSelectedModal.modal('show');
        });
      }

      if (saveSelectedConfirmBtn) {
        saveSelectedConfirmBtn.addEventListener('click', async () => {
          if (!selectedImages.size) {
            saveSelectedModal.modal('hide');
            return;
          }
          if (saveSelectedConfirmBtn) {
            saveSelectedConfirmBtn.disabled = true;
          }
          const nImages = selectedImages.size;
          const estSeconds = nImages * 3;
          if (saveSelectedStatusEl) {
            saveSelectedStatusEl.style.display = 'block';
            saveSelectedStatusEl.innerHTML =
              `<span class="spinner-border spinner-border-sm mr-1" role="status" aria-hidden="true"></span>` +
              `Saving ${nImages} image(s)… approximately ${estSeconds} s`;
          }
          const imagesPayload = Array.from(selectedImages.values()).map(it => ({
            plate_acq_id: it.acqId,
            well: it.wellId,
            site: it.siteKey,
            ch1: it.ch1 || null,
            ch2: it.ch2 || null,
            ch3: it.ch3 || null,
            batch_id: it.batchId || null,
            compound_name: it.compoundName || null,
            project: it.projectName || null,
            barcode: it.barcode || null,
          }));
          const payload = {
            merged_rgb: !!(optMerged && optMerged.checked),
            original_channels: !!(optOriginal && optOriginal.checked),
            normalize: !!(normalizeCb && normalizeCb.checked),
            equalize: !!(equalizeCb && equalizeCb.checked),
            images: imagesPayload,
          };
          try {
            saveAbortController = new AbortController();
            const resp = await fetch('/api/save-selected-images', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
              signal: saveAbortController.signal,
            });
            if (!resp.ok) {
              const txt = await resp.text();
              throw new Error(`Save failed: ${resp.status} ${txt}`);
            }
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'selected-images.zip';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          } catch (err) {
            if (err.name === 'AbortError') {
              // User cancelled; no error dialog
              console.log('Save selected images request aborted by user');
            } else {
              console.error(err);
              showError(String(err));
            }
          } finally {
            saveSelectedModal.modal('hide');
            if (saveSelectedConfirmBtn) {
              saveSelectedConfirmBtn.disabled = false;
            }
            if (saveSelectedStatusEl) {
              saveSelectedStatusEl.style.display = 'none';
              saveSelectedStatusEl.textContent = '';
            }
            saveAbortController = null;
          }
        });
      }

      if (saveSelectedCancelBtn) {
        saveSelectedCancelBtn.addEventListener('click', () => {
          if (saveAbortController) {
            saveAbortController.abort();
          }
        });
      }
      const C = {
        projects: document.getElementById('count-projects'),
        plates:   document.getElementById('count-plates'),
        acqs:     document.getElementById('count-acqs'),
        wells:    document.getElementById('count-wells'),
      };
      function setCounts(obj) {
        if (!C.projects) return;
        C.projects.textContent = obj.projects ?? 0;
        C.plates.textContent   = obj.plates ?? 0;
        C.acqs.textContent     = obj.acquisitions ?? 0;
        C.wells.textContent    = obj.wells ?? 0;
      }
      function computeCounts(projectsRootObj) {
        const result = { projects: 0, plates: 0, acquisitions: 0, wells: 0 };
        if (!projectsRootObj) return result;
        const projEntries = Object.entries(projectsRootObj);
        result.projects = projEntries.length;
        for (const [, proj] of projEntries) {
          const plates = proj?.plates ? Object.entries(proj.plates) : [];
          result.plates += plates.length;
          for (const [, plate] of plates) {
            const acqs = plate?.acquisitions ? Object.entries(plate.acquisitions) : [];
            result.acquisitions += acqs.length;
            for (const [, acq] of acqs) {
              const wells = acq?.wells ? acq.wells.length : 0;
              result.wells += wells;
            }
          }
        }
        return result;
      }

      const zoomEl       = document.getElementById('zoom-range');

      function showError(text) {
        errorMsgPre.textContent = text;
        errorModal.modal('show');
      }

      // Format ISO date string in Swedish locale
      const fmtDate = (iso) => {
        const d = new Date(iso);
        return Number.isNaN(d) ? (iso?.slice?.(0,10) ?? "") : d.toLocaleDateString('sv-SE');
      };

      function getLimit(id) {
        const v = parseInt(document.getElementById(id).value, 10);
        return Number.isFinite(v) && v > 0 ? v : Infinity;
      }

      function applyImageSettings(rootEl = document) {
        const b = (parseInt(brightnessEl.value,10) || 100) / 100;
        const z = (parseInt(zoomEl.value,10) || 100) / 100;
        rootEl.querySelectorAll('.thumb-card img').forEach(img => {
          img.style.filter = `brightness(${b})`;
        });
        const size = 120 * z;
        rootEl.querySelectorAll('.thumb-grid').forEach(grid => {
          grid.style.gridTemplateColumns = `repeat(auto-fit, minmax(${size}px, ${size}px))`;
        });
      }

      brightnessEl.addEventListener('input', () => applyImageSettings(treeRoot));
      zoomEl.addEventListener('input', () => applyImageSettings(treeRoot));

      // Re-render on limit changes if a term is present
      ['limit-plates','limit-acqs','limit-wells','limit-sites'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', () => {
          const term = document.getElementById('q').value.trim();
          if (term) renderSearchResults(term);
        });
      });
      // For normalize/equalize, keep tree expanded and just retarget thumbs
      [normalizeCb, equalizeCb].forEach(cb => {
        if (cb) cb.addEventListener('change', () => {
          const imgs = treeRoot.querySelectorAll('.thumb-card img');
          imgs.forEach(img => {
            const base = img.src.split('?', 1)[0];
            img.src = addThumbFilterParams(base);
          });
        });
      });

      // Cache plate fetches by (barcode|acqId|wellsCsv)
      const plateCache = new Map();

      function thumbUrlFromChannels(chArr) {
        const paths = chArr.slice(0,3).map(c => encodeURIComponent(c?.path || ''));
        while (paths.length < 3) paths.push(paths[paths.length-1] || '');
        const base = `/api/image-merge-thumb/ch1/${paths[0]}/ch2/${paths[1]}/ch3/${paths[2]}/channels.png`;
        return addThumbFilterParams(base);
      }

      function makeDetails(summaryText, extra = '') {
        const d = document.createElement('details');
        const s = document.createElement('summary');
        s.innerHTML = summaryText + (extra ? ` <span class="badge">${extra}</span>` : '');
        d.appendChild(s);
        return [d, s];
      }

      async function fetchPlateSubset(barcode, acqId, wellsCsv) {
        const key = `${barcode}|${acqId}|${wellsCsv}`;
        if (plateCache.has(key)) return plateCache.get(key);
        const resp = await withSemaphore(() =>
          fetch(`/api/plate/${encodeURIComponent(barcode)}/${acqId}/${wellsCsv}`)
        );
        if (!resp.ok) throw new Error(`Fetch plate failed: ${barcode} acq ${acqId}`);
        const json = await resp.json();
        plateCache.set(key, json);
        return json;
      }

      // Put these once (top-level)
      let renderToken = 0;
      let currentAbort = null;

      // --- render function (no cache) ---
      async function renderSearchResults(term) {
        const treeRoot = document.getElementById('tree-root');

        // Abort any in-flight render
        if (currentAbort) currentAbort.abort();
        currentAbort = new AbortController();
        const { signal } = currentAbort;

        // Token to invalidate stale async work
        const myToken = ++renderToken;

        // Hard clear existing tree and selection
        treeRoot.replaceChildren();
        selectedImages.clear();
        updateSelectedCount();
        refreshSelectedList();

        // local helpers (no cache)
        async function fetchJSON(url, signal) {
          const resp = await fetch(url, { signal });
          if (!resp.ok) {
            let detail = '';
            try {
              detail = await resp.text();
            } catch (_) {}
            const msg = detail ? `${resp.status} ${resp.statusText}: ${detail}` : `${resp.status} ${resp.statusText}`;
            throw new Error(msg);
          }
          return resp.json();
        }
        async function fetchPlateSubsetInner(barcode, acqId, wellsCsv, signal) {
          // use semaphore here too for inner fetch path
          return withSemaphore(() => fetchJSON(`/api/plate/${encodeURIComponent(barcode)}/${acqId}/${wellsCsv}`, signal));
        }
        function makeDetailsInner(summaryText, badgeText = '') {
          const d = document.createElement('details');
          const s = document.createElement('summary');
          s.innerHTML = summaryText + (badgeText ? ` <span class="badge">${badgeText}</span>` : '');
          d.appendChild(s);
          return [d, s];
        }
        function thumbUrlFromChannelsInner(chArr) {
          const paths = chArr.slice(0, 3).map(c => encodeURIComponent(c?.path || ''));
          while (paths.length < 3) paths.push(paths[paths.length - 1] || '');
          const base = `/api/image-merge-thumb/ch1/${paths[0]}/ch2/${paths[1]}/ch3/${paths[2]}/channels.png`;
          return addThumbFilterParams(base);
        }

        const L_PLATES = getLimit('limit-plates');
        const L_ACQS   = getLimit('limit-acqs');
        const L_WELLS  = getLimit('limit-wells');
        const L_SITES  = getLimit('limit-sites');

        // Build query string (also pass limits to server)
        const qs = new URLSearchParams({
          q: term,
          limit: '100000',
          ...(Number.isFinite(L_PLATES) ? { limit_plates: String(L_PLATES) } : {}),
          ...(Number.isFinite(L_ACQS)   ? { limit_acqs:   String(L_ACQS)   } : {}),
          ...(Number.isFinite(L_WELLS)  ? { limit_wells:  String(L_WELLS)  } : {}),
        }).toString();

        // Fetch hierarchical search result
        let json;
        try {
          json = await fetchJSON(`/api/search-compound?${qs}`, signal);
        } catch (e) {
          if (signal.aborted) return; // superseded by a newer render
          showError(String(e));
          return;
        }
        if (myToken !== renderToken) return;

        const projectsRootObj = json?.data?.projects;
        // Update summary counts
        const countsFromMeta = json && json.meta && json.meta.counts ? json.meta.counts : null;
        setCounts(countsFromMeta || computeCounts(projectsRootObj));
        if (!projectsRootObj || !Object.keys(projectsRootObj).length) {
          setCounts({projects:0, plates:0, acquisitions:0, wells:0});
          treeRoot.textContent = 'No results found.';
          return;
        }

        // Root: "Projects"
        const [projectsRoot] = makeDetailsInner('Projects');
        projectsRoot.open = true;
        if (myToken !== renderToken) return;
        treeRoot.appendChild(projectsRoot);


        // Iterate: project -> plates -> acquisitions -> wells
        // Sort projects by date (latest first) or by name (A–Ö) based on SORT_MODE
        const projectEntries = Object.entries(projectsRootObj);
        projectEntries.sort((a, b) => {
          if (SORT_MODE === 'name') {
            return a[0].localeCompare(b[0], 'sv-SE', { sensitivity: 'base' });
          } else {
            const da = Date.parse(a[1]?.date_iso || '') || 0;
            const db = Date.parse(b[1]?.date_iso || '') || 0;
            return db - da; // latest first
          }
        });
        for (const [projectName, projectObj] of projectEntries) {
          if (myToken !== renderToken) return;

          const projDateHTML = projectObj?.date_iso
            ? ` <span class="badge-date">${fmtDate(projectObj.date_iso)}</span>`
            : '';
          const [projDet] = makeDetailsInner(`${projectName}${projDateHTML}`);
          projectsRoot.appendChild(projDet);


          const plates = projectObj?.plates || {};
          const plateEntries = Object.entries(plates).slice(
            0, Number.isFinite(L_PLATES) ? L_PLATES : undefined
          );

          for (const [barcode, plateObj] of plateEntries) {
            if (myToken !== renderToken) return;

            const acqs = plateObj?.acquisitions || {};
            const acqEntries = Object.entries(acqs).slice(
              0, Number.isFinite(L_ACQS) ? L_ACQS : undefined
            );

            const [plateDet] = makeDetailsInner(`Plate ${barcode}`, `${acqEntries.length} acq`);
            plateDet.dataset.barcode = barcode;
            projDet.appendChild(plateDet);

            // Lazy build acquisitions when plate is expanded
            plateDet.addEventListener('toggle', () => {
              if (!plateDet.open || plateDet.dataset.loaded === '1') return;
              if (myToken !== renderToken) return;

              for (const [acqId, acqObj] of acqEntries) {
                const wellsArr = Array.isArray(acqObj?.wells) ? acqObj.wells : [];
                const wellsPlanned = wellsArr.slice(
                  0, Number.isFinite(L_WELLS) ? L_WELLS : undefined
                );

                // ✨ Add the date from the API (ISO string) after the acquisition id
                const acqDateHTML = acqObj?.date_iso
                  ? ` <span class="badge-date">${fmtDate(acqObj.date_iso)}</span>`
                  : '';
                const [acqDet] = makeDetailsInner(`Acq ${acqId}${acqDateHTML}`, `${wellsPlanned.length} wells`);
                acqDet.dataset.acqId = acqId;
                plateDet.appendChild(acqDet);

                // Lazy load thumbnails for the acquisition
                acqDet.addEventListener('toggle', async () => {
                  if (!acqDet.open || acqDet.dataset.loaded === '1') return;
                  if (myToken !== renderToken) return;

                  let plateJson;
                  try {
                    const wellsCsv = wellsPlanned.join(',');
                    plateJson = await fetchPlateSubsetInner(barcode, acqId, wellsCsv, signal);
                  } catch (e) {
                    if (signal.aborted || myToken !== renderToken) return;
                    console.error(e);
                    showError(String(e));
                    return;
                  }
                  if (myToken !== renderToken) return;

                  const plateNode = plateJson?.data?.plates?.[barcode];
                  const acqMap    = plateNode?.acquisitions || {};
                  const acqRec    = acqMap[String(acqId)] ?? acqMap[Number(acqId)];
                  const wellsObj  = acqRec?.wells || {};
                  const layoutMap = plateNode?.layout || {};

                  const grid = document.createElement('div');
                  grid.className = 'thumb-grid';
                  acqDet.appendChild(grid);

                  for (const wellId of wellsPlanned) {
                    if (myToken !== renderToken) return;

                    const wellData = wellsObj[wellId];
                    if (!wellData) continue;

                    const wellLayoutList = Array.isArray(layoutMap[wellId]) ? layoutMap[wellId] : [];
                    const wellMeta = wellLayoutList[0] || {};

                    let sitesRendered = 0;
                    for (const [siteKey, siteInfo] of Object.entries(wellData.sites || {})) {
                      if (sitesRendered >= (Number.isFinite(L_SITES) ? L_SITES : Infinity)) break;

                      const zInfo = Object.values(siteInfo.z_positions || {})[0] || {};
                      let ch = Array.isArray(zInfo.channels)
                        ? zInfo.channels
                        : Object.values(zInfo.channels || {});
                      while (ch.length < 3) ch.push(ch[ch.length - 1] || {});
                      const thumb = thumbUrlFromChannelsInner(ch);

                      const card = document.createElement('div');
                      card.className = 'thumb-card';
                      card.dataset.barcode = barcode;
                      card.dataset.acqId = acqId;
                      card.dataset.wellId = wellId;
                      card.dataset.siteKey = siteKey;
                      card.dataset.projectName = projectName;
                      if (acqObj && acqObj.date_iso) {
                        card.dataset.acqDateIso = acqObj.date_iso;
                      }
                      if (wellMeta) {
                        if (wellMeta.batch_id !== undefined && wellMeta.batch_id !== null) {
                          card.dataset.batchId = String(wellMeta.batch_id);
                        }
                        if (wellMeta.compound_name !== undefined && wellMeta.compound_name !== null) {
                          card.dataset.compoundName = String(wellMeta.compound_name);
                        }
                      }
                      card.dataset.ch1 = ch[0]?.path || '';
                      card.dataset.ch2 = ch[1]?.path || '';
                      card.dataset.ch3 = ch[2]?.path || '';

                      const key = makeSelectionKey(barcode, acqId, wellId, siteKey);
                      const isSelected = selectedImages.has(key);

                      card.innerHTML = `
                        <input type="checkbox" class="thumb-select-check" ${isSelected ? 'checked' : ''}>
                        <button type="button" class="btn btn-sm btn-light thumb-info-btn">i</button>
                        <img src="${thumb}" alt="Well ${wellId} • Site ${siteKey}">
                        <div class="thumb-meta">Well ${wellId} • Site ${siteKey}</div>
                      `;

                      if (isSelected) {
                        card.classList.add('thumb-selected');
                      }

                      const check = card.querySelector('.thumb-select-check');
                      if (check) {
                        check.addEventListener('click', ev => {
                          ev.stopPropagation();
                        });
                        check.addEventListener('change', () => {
                          toggleThumbSelection(card, check.checked);
                        });
                      }

                      const infoBtn = card.querySelector('.thumb-info-btn');
                      if (infoBtn) {
                        infoBtn.addEventListener('click', ev => {
                          ev.preventDefault();
                          ev.stopPropagation();
                          openInfoPanel(card, siteInfo);
                        });
                      }

                      card.addEventListener('click', ev => {
                        ev.preventDefault();
                        openViewerFromThumb(card, siteInfo);
                      });
                      grid.appendChild(card);

                      sitesRendered++;
                    }
                  }

                  applyImageSettings(acqDet);
                  acqDet.dataset.loaded = '1';
                });
              }

              plateDet.dataset.loaded = '1';
            });
          }
        }
      }


      // Hook search form
      document.getElementById('search-form').addEventListener('submit', e => {
        e.preventDefault();
        const term = document.getElementById('q').value.trim();

        // Update URL ?q=... so refresh/back restores the search
        try {
          const url = new URL(window.location.href);
          if (term) {
            url.searchParams.set('q', term);
          } else {
            url.searchParams.delete('q');
          }
          window.history.replaceState(null, '', url.toString());
        } catch (err) {
          console.error('Failed to update URL with q param', err);
        }

        renderSearchResults(term);
      });

      // On initial load, if ?q=... is present, restore and run the search
      try {
        const url = new URL(window.location.href);
        const initialQ = (url.searchParams.get('q') || '').trim();
        if (initialQ) {
          const qInput = document.getElementById('q');
          if (qInput) qInput.value = initialQ;
          renderSearchResults(initialQ);
        }
      } catch (err) {
        console.error('Failed to read q from URL', err);
      }
    });

  </script>
</body>
</html>
