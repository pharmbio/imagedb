<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>ImageDB – Compound Search</title>
  <link rel="shortcut icon" href="/static/pharmbio_logo_square_64x64.png" type="image/x-icon">

  <!-- Bootstrap & your CSS -->
  <link href="/static/theme/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/theme/css/simple-sidebar.css"          rel="stylesheet">
  <link rel="stylesheet" href="/static/main.css?version=1.x">
  <style>
    .plate-group + .plate-group { margin-top:2rem }
    .plate-header { font-weight:bold; margin-bottom:.5rem }
    .image-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,120px));
      gap:1rem;
    }
    .thumb-card {
      position:relative; overflow:hidden;
      border-radius:4px; background:#f8f8f8;
      cursor:pointer;
    }
    .thumb-card img {
      width:100%; height:auto; transition:filter .2s;
    }
    .thumb-meta {
      position:absolute; bottom:0; left:0; right:0;
      background:rgba(0,0,0,0.5); color:#fff;
      font-size:.8rem; padding:.2rem; text-align:center;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-light bg-light border-bottom">
    <form id="search-form" class="form-inline mx-3" onsubmit="return false;">
      <input type="text" id="q" class="form-control mr-2"
             placeholder="batchid, name, inchi…" required>
      <button class="btn btn-info">Search</button>
    </form>
  </nav>

  <div class="container-fluid mt-3">
    <div class="form-inline mb-3">
      <label class="mr-3">
        Brightness
        <input type="range" id="brightness-range" min="50" max="3000"
               value="100" class="form-control-range ml-2">
      </label>
      <label>
        Zoom
        <input type="range" id="zoom-range" min="50" max="200"
               value="100" class="form-control-range ml-2">
      </label>
    </div>
    <div id="results-container"></div>
  </div>

  <!-- Error Modal -->
  <div id="error-modal" class="modal fade">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Error</h5>
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body"><pre id="error-message" style="white-space:pre-wrap"></pre></div>
    </div></div>
  </div>

  <script src="/static/theme/vendor/jquery/jquery.min.js"></script>
  <script src="/static/theme/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/static/main.js?version=1.23"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const resultsContainer = document.getElementById('results-container');
    const brightnessEl     = document.getElementById('brightness-range');
    const zoomEl           = document.getElementById('zoom-range');
    const errorModal       = $('#error-modal');
    const errorMsgPre      = document.getElementById('error-message');

    function applyImageSettings() {
      const b = (parseInt(brightnessEl.value,10)||100)/100;
      const z = (parseInt(zoomEl.value,10)||100)/100;
      document.querySelectorAll('.thumb-card img').forEach(img => {
        img.style.filter = `brightness(${b})`;
      });
      const size = 120 * z;
      document.querySelectorAll('.image-grid').forEach(grid => {
        grid.style.gridTemplateColumns =
          `repeat(auto-fit, minmax(${size}px,${size}px))`;
      });
    }
    brightnessEl.addEventListener('input', applyImageSettings);
    zoomEl.addEventListener('input',       applyImageSettings);

    function showError(text) {
      errorMsgPre.textContent = text;
      errorModal.modal('show');
    }

    async function renderSearchResults(term) {
      resultsContainer.innerHTML = '';
      applyImageSettings();

      // Phase 1: flat list of { barcode, plate_acquisition_id, well_id }
      let resp = await fetch(
        `/api/search-compound?q=${encodeURIComponent(term)}&limit=1000`
      );
      if (!resp.ok) {
        const t = await resp.text().catch(()=>resp.statusText);
        return showError(`Search failed: ${t}`);
      }
      const { results } = await resp.json();
      if (!results.length) {
        return resultsContainer.textContent = 'No results found.';
      }

      // Group by acquisition (barcode + acqId)
      const byAcq = {};
      for (const r of results) {
        const key = `${r.barcode}|${r.plate_acquisition_id}`;
        if (!byAcq[key]) {
          byAcq[key] = {
            barcode: r.barcode,
            acqId:   r.plate_acquisition_id,
            wells:   []
          };
        }
        byAcq[key].wells.push(r.well_id);
      }

      // Phase 1 skeleton blocks
      for (const { barcode, acqId } of Object.values(byAcq)) {
        const group = document.createElement('div');
        group.className     = 'plate-group';
        group.dataset.acqId = acqId;
        group.innerHTML     = `
          <div class="plate-header">
            ${barcode} | Acquisition ${acqId}
          </div>
          <div class="image-grid"></div>
        `;
        resultsContainer.append(group);
        await new Promise(r => requestAnimationFrame(r));
      }

      // Phase 2: fetch + render each acquisition’s images
      for (const { barcode, acqId, wells } of Object.values(byAcq)) {
        const group = document.querySelector(`[data-acq-id="${acqId}"]`);
        const grid  = group.querySelector('.image-grid');

        // Path-based fetch to include both acqId & wells
        resp = await fetch(
          `/api/plate/${encodeURIComponent(barcode)}/`
          + `${acqId}/`
          + `${wells.join(',')}`
        );
        if (!resp.ok) {
          showError(`Failed to load plate ${barcode} acq ${acqId}`);
          continue;
        }

        // Handler returns single plate_data with .acquisitions…
        const plateData   = await resp.json();
        const acqus       = plateData.acquisitions || [];
        const acqRecord   = acqus[0];
        if (!acqRecord || !acqRecord.wells) continue;

        grid.innerHTML = '';
        for (const [wellId, wellData] of Object.entries(acqRecord.wells)) {
          for (const [siteKey, siteInfo] of Object.entries(wellData.sites||{})) {
            const zInfo = Object.values(siteInfo.z_positions||{})[0]||{};
            let ch = Array.isArray(zInfo.channels)
                       ? zInfo.channels
                       : Object.values(zInfo.channels||{});
            while (ch.length < 3) ch.push(ch[ch.length-1]||{});
            const paths = ch.slice(0,3).map(c=>encodeURIComponent(c.path||''));
            const thumb = `/api/image-merge-thumb/` +
                          `ch1/${paths[0]}/ch2/${paths[1]}/ch3/${paths[2]}/channels.png`;

            const card = document.createElement('div');
            card.className = 'thumb-card';
            card.innerHTML = `
              <img src="${thumb}" alt="Well ${wellId} • Site ${siteKey}">
              <div class="thumb-meta">Well ${wellId} • Site ${siteKey}</div>
            `;
            card.onclick = () => openViewer(wellId, siteKey);
            grid.append(card);
          }
        }

        applyImageSettings();
        await new Promise(r => requestAnimationFrame(r));
      }
    }

    document.getElementById('search-form')
      .addEventListener('submit', e => {
        e.preventDefault();
        renderSearchResults(document.getElementById('q').value.trim());
      });
  });
  </script>
</body>
</html>
